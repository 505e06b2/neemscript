<html>
<head>
<meta charset="utf8">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<title>Neemscript Interpreter</title>
<script src="instascan.min.js"></script>
<script src="neemscript.js"></script>
<script>
var outbox;
var inbox;
var interpret;
var scanner;
var qrbox;

function runcode(script) {
	if(interpret === undefined) {
		alert('Can\'t load Neemscript... Try refreshing');
		return;
	}
	interpret(script);
	inbox.focus();
}

function resetqr() {
	document.getElementById("replacescript").disabled = true;
	document.getElementById("runscript").disabled = true;
	qrbox.value = "";
}

function toggleqr() {
	var qrwindow = document.getElementById("qrwindow");
	if(qrwindow.style.display == "none") {
		qrwindow.style.display = "block";
		Instascan.Camera.getCameras().then(function (cameras) {
			if (cameras.length > 0) {
				scanner.start(cameras[0]);
			} else {
				console.error('No cameras found.');
			}
		}).catch(function (e) {
			console.error(e);
		});
	} else {
		qrwindow.style.display = "none";
		scanner.stop();
	}
}

window.onload = function() {
	outbox = document.getElementById('output');
	inbox = document.getElementById('input');
	qrbox = document.getElementById('qrbox');
	inbox.focus();
	resetqr();
	inbox.onkeydown = function(e) {
		if(e.keyCode == 9) { //Tab
			e.preventDefault();
			this.value += "\t";
		} else if(e.ctrlKey) {
			if(e.keyCode == 81) { //Ctrl + Q
				e.preventDefault();
				runcode(inbox.value);
			} else if(e.keyCode == 83) { //Ctrl + S
				e.preventDefault();
				localStorage.setItem("script", this.value);
				Module.print("[*] Saved script to localStorage");
			} else if(e.keyCode == 79) { //Ctrl + O
				e.preventDefault();
				this.value = localStorage.getItem("script");
				Module.print("[*] Loaded script from localStorage");
			} else if(e.keyCode == 87) { //Ctrl + W
				e.preventDefault();
				outbox.value = "[*] Cleared Output\n";
			}
		}
	}
	
	Module.print = function(text) {
		outbox.value += text + '\n';
		outbox.scrollTop = outbox.scrollHeight;
	};	
	Module.printErr = Module.print;
	
	Module.onRuntimeInitialized = function() {
		interpret = Module.cwrap('webmain', null, ['string']);
		console.log("Loaded Neemscript");
		var temp = localStorage.getItem("script");
		if(temp) {
			this.value = temp;
			Module.print("[*] Tried to load script from localStorage; if it didn't work, press CTRL+O");
		}
	}
	
	scanner = new Instascan.Scanner({ video: document.getElementById("qrpreview") });
	scanner.addListener('scan', function (content) {
        qrbox.value = content;
		document.getElementById("replacescript").disabled = false;
		document.getElementById("runscript").disabled = false;
    });
};

</script>
<style>
body, textarea {
	background: #1a1a1a;
	color: #eee;
	padding:0;
	margin:0;
	font-family: monospace;
}

table {
	width:100%;
	height:100%;
}

th, .header {
	height: 30px;
	font-size: 18px;
	font-family: monospace;
}

textarea {
	resize: none;
	width: 100%;
	height: 100%;
	z-index:10;
}

.ontop {
	background:#333;padding:5px;border:solid 2px #eee
}

a {
	color: #eee;
	text-decoration: none;
	background: #333;
	padding-top:5px;
	padding-left:5px;
	padding-right:5px;
}

#qrpreview {
	height:100% !important;
	width:auto !important;
}

#replacescript, #runscript {
	width:auto;
}

#info {
	display: none;
}

#infobutton:hover~#info {
    display: block;
}

button {width:100%;}
</style>
</head>
<body>
<a class="header" id="infobutton" href="#" onclick="return false" style="position:absolute;left:5px;top:0px">[?]</a>
<a class="header" href="#" onclick="resetqr();toggleqr();return false" style="position:absolute;left:55px;top:0px">[QR]</a>
<table>
	<tr><th>Input</th><th>Output</th></tr>
	<tr><td><textarea id="input"></textarea></td><td rowspan="2"><textarea id="output" readonly style="right:0;"></textarea></td></tr>
	<tr><td style="height:15px;"><button onclick="runcode(inbox.value)">Run</button></td></tr>
</table>
<div id="info" class="ontop" style="position:absolute;left:10px;top:35px;">
<div class="header">Shortcuts:</div>
Run Code: CTRL+Q<br>
Save Code: CTRL+S<br>
Open Code: CTRL+O<br>
Clear Output: CTRL+W
</div>
<div id="qrwindow" class="ontop" style="position:absolute;z-index:100;height:90%;width:50%;left:25%;top:5%;display:none;text-align:center;">
<div style="background:#000; width:100%; height:50%;text-align:center"><video id="qrpreview"></video></div>
<textarea id="qrbox" readonly style="height:35%;" placeholder="[Script will show up here]"></textarea><br><br>
<button id="replacescript" onclick="input.value = qrbox.value">Replace Script</button>
<button id="runscript" onclick="toggleqr();Module.print('[*] Running QR Script');setTimeout(function() {runcode(qrbox.value);resetqr()}, 500);">Run</button>
</div>
</body>
</html>