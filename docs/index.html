<html>
<head>
<meta charset="utf8">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<title>Neemscript Interpreter</title>
<script src="instascan.min.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
<script>
var outbox;
var inbox;
var interpret;
var scanner;
var qrbox;
var currentcam;

window.onbeforeunload = function() {
	return true;
}

function runcode(script) {
	if(interpret === undefined) {
		alert('Can\'t load Neemscript... Try refreshing');
		return;
	}
	interpret(script);
	inbox.focus();
}

function loadcode() {
	var temp = localStorage.getItem("script");
	if(!temp) return false;
	inbox.value = localStorage.getItem("script");
	Module.print("[*] Loaded script from localStorage");
}

function savecode() {
	localStorage.setItem("script", inbox.value);
	Module.print("[*] Saved script to localStorage");
}

function resetqr() {
	document.getElementById("replacescript").disabled = true;
	document.getElementById("runscript").disabled = true;
	qrbox.value = "";
}

function changeCamera(id) {
	Instascan.Camera.getCameras().then(function (cameras) {
		if (cameras.length > 0) {
			currentcam = cameras[id];
			scanner.start(currentcam);
		}
	});
}

function toggleqr() {
	var qrwindow = document.getElementById("qrwindow");
	if(qrwindow.style.display == "none") {
		qrwindow.style.display = "block";
		scanner.start(currentcam);
	} else {
		qrwindow.style.display = "none";
		scanner.stop();
	}
}

function stopaction(e) {
	if(e.preventDefault) e.preventDefault();
    if(e.stopPropagation) e.stopPropagation();
}

window.onload = function() {
	outbox = document.getElementById('output');
	inbox = document.getElementById('input');
	qrbox = document.getElementById('qrbox');
	inbox.focus();
	resetqr();
	inbox.onkeydown = function(e) {
		if(e.keyCode == 9) { //Tab
			stopaction(e);
			this.value += "\t";
		} else if(e.ctrlKey) {
			if(e.keyCode == 81) { //Ctrl + Q
				stopaction(e);
				runcode(inbox.value);
			} else if(e.keyCode == 83) { //Ctrl + S
				stopaction(e);
				savecode();
			} else if(e.keyCode == 79) { //Ctrl + O
				stopaction(e);
				loadcode();
			} else if(e.keyCode == 87) { //Ctrl + W
				stopaction(e);
				outbox.value = "[*] Cleared Output\n";
			}
		}
	}
	
	scanner = new Instascan.Scanner({ video: document.getElementById("qrpreview") });
	scanner.addListener('scan', function (content) {
        qrbox.value = content;
		document.getElementById("replacescript").disabled = false;
		document.getElementById("runscript").disabled = false;
    });
	Instascan.Camera.getCameras().then(function (cameras) {
		if (cameras.length > 0) {
			var camselect = document.getElementById("cameraselect");
			camselect.innerHTML = "";
			for(var i = 0; i < cameras.length; i++) {
				camselect.innerHTML += "<option value='" + i + "'>" + cameras[i].name + "</option>";
			}
			currentcam = cameras[0];
		} else {
			console.error('No cameras found.');
		}
	}).catch(function (e) {
		console.error(e);
	});
	
	var neemloader = document.createElement("script");
	neemloader.onload = function() {
		Module.print = function(text) {
			outbox.value += text + '\n';
			outbox.scrollTop = outbox.scrollHeight;
		};	
		Module.printErr = Module.print;
	
		Module.onRuntimeInitialized = function() {
			interpret = Module.cwrap('webmain', null, ['string']);
			console.log("Loaded Neemscript");
			Module.print("[*] Neemscript runtime loaded");
			loadcode();
		}
	}
	
	var t;
	if(typeof WebAssembly === "undefined") {
		neemloader.src = "neemscript.js";
		t = "asm.js";
	} else {
		neemloader.src = "neemscript_wasm.js";
		t = "wasm";
	}
	outbox.value += "\n[*] Using " + t + " for Neemscript\n";
	document.head.appendChild(neemloader);
};

</script>
</head>
<body>
<a class="header" id="infobutton" href="#Show Hotkeys and info" onclick="return false" style="position:absolute;left:5px;top:0px">[?]</a>
<a class="header" href="#Click to open QR Reader" onclick="resetqr();toggleqr();return false" title="Click to open QR Reader" style="position:absolute;left:55px;top:0px">[QR]</a>
<table>
	<tr><th>Input</th><th>Output</th></tr>
	<tr><td><textarea id="input"></textarea></td><td rowspan="2"><textarea id="output" readonly style="right:0;">[*] Loading Neemscript...</textarea></td></tr>
	<tr><td class="buttonpanel" style="height:30px;text-align:center"><button onclick="runcode(inbox.value)">Run</button><button onclick="loadcode()">Load</button><button onclick="savecode()">Save</button></td></tr>
</table>
<div id="info" class="ontop" style="position:absolute;left:10px;top:35px;">
<div class="header">Shortcuts:</div>
Run Code: CTRL+Q<br>
Save Code: CTRL+S<br>
Open Code: CTRL+O<br>
Clear Output: CTRL+W<br>
<hr>
<div class="header">Errors with WASM?:</div>
Try disabling adblock for this page
</div>
<div id="qrwindow" class="ontop" style="position:absolute;z-index:100;height:90%;width:50%;left:25%;top:5%;display:none;text-align:center;">
<div style="background:#000; width:100%; height:50%;text-align:center;margin-bottom:2%;"><video id="qrpreview"></video></div>
<textarea id="qrbox" readonly style="height:39%;" placeholder="[Script will show up here]"></textarea><br><br>
<button id="replacescript" onclick="input.value = qrbox.value">Replace Input with this script</button>
<button id="runscript" onclick="toggleqr();Module.print('[*] Running QR Script');setTimeout(function() {runcode(qrbox.value);resetqr()}, 500);">Run</button>
<select id="cameraselect" onchange="changeCamera(this.value)"><option value="" selected>Loading Camera List...</option></select>
</div>
</body>
</html>